# Flow 架构设计

[English](./flow-arch.md)

## 概述

Penless Flow 是一种可视化编程工具，它允许用户通过拖放节点并用边连接它们来创建流。

流引擎在服务器端运行，并通过 RESTful API（或可行时的 WebSocket）与客户端同步状态。

这个项目建立在 react-flow 之上，react-flow 是一个用于构建基于节点的编辑器和图表的 React 库。 所以我们从中借鉴了很多基本概念来简化我们的系统设计和实现，比如流、节点、边缘等。

## 数据结构

### 什么在Flow中流动？

这是一个非常重要的讨论话题。 为了让流引擎尽可能通用，我们需要定义流中流动的数据结构。 数据结构应该能够表示任何类型的数据，例如文本、JSON 对象、二进制文件等。

由于我们的关键场景是面向AIGC（人工智能生成内容）的，并且每个内容都可以简单地映射到一个文件。 所以我们将使用文件作为流中流动的基本数据结构。 为了便于描述，我们将使用 JSON 作为顶级数据格式，以表示二进制文件、短文本或长文本或 JSON 对象。 基本结构如下：

```json
{
  "type": "text",
  "name": "test.txt",
  "description": "This is a test file",
  "format": "utf-8",
  "data": "This is a test file"
}
```

并非所有字段都是必需的，但“类型”和“数据”是必需的。 `type` 字段用于指示数据的类型，可以是以下之一：

* text（默认为 utf-8，或由 `format` 字段指定）
* json
* image（还需要指定`format`字段，比如png, jpg, gif等）

因此，每个端口都应包含相应的数据模式。 例如，一个文本分类器节点当然应该只将文本作为输入和输出文本。 该架构将与以下内容类似：

```json
{
  "type": "text",
  "conditions": {
    "minLength": "30",
    "maxLength": "4096",
  }
}
```

或图像：

```json
{
  "type": "image",
  "format": "png|jpg|webp",
  "conditions": {
    "dataFormat": "base64",
  }
}
```

这些只是用于解释目的的一些示例，而不是最终规范。 这些规则可以指导我们进行节点操作，例如确定我们是否可以将两个节点连接在一起。

### 逻辑控制

在运行流引擎时，我们当然需要支持基本的逻辑控制，比如if-else、switch-case、for-loop等。我们将使用如下JSON schema来表示逻辑控制：

```json
{
  "type": "if",
  "condition": "data.length > 100",
  "true": {
    "type": "node",
    "id": "node-1"
  },
  "false": {
    "type": "node",
    "id": "node-2"
  }
}
```

我们需要想出解决方案：是提供一套内置的逻辑控件，还是始终将逻辑集成在任务节点中？ 例如，对于文本分类器节点，我们可以提出一个是或否的问题作为提示，然后根据答案来确定下一步去哪个节点。 或者我们可以提供一个内置的 if-else 节点，然后根据结果来决定下一步去哪个节点。

前者更灵活方便，后者更简洁，更程序员方式。 现在，我们将选择前者。 挑战在于如何做出判断。 我们可以参考Waveline的案例：

![waveline-logic-control](https://waveline.ai/_next/static/media/workflow-example.58a6808d.svg)

从这个案例研究中，我们可能应该提供一组内置的逻辑控制，例如 if-else、switch-case、for-loop 等。我们还应该提供一种将逻辑集成到任务节点中的方法，例如 作为文本分类器节点。 这意味着我们需要提供必要的提示，使结果具有可解释性，并用结果触发不同的输出端口。

我们不建议用循环来让逻辑流程变得复杂，因为这样设计和实现起来都会很困难，所以我们会采用DAG方法。 但是，如果人们真的需要一种循环，我们可以提供一种方法来实现，比如提供一个中间件来存储结果，并以上次运行的结果作为输入重复触发流评估。

### 节点（Node）

每个节点都有以下关键属性：

* 唯一身份
* 名称，不要求唯一，仅供展示
* 描述，与名称相同，仅供展示
* 类型，以下之一：
   * 开始
   * 结尾
   * 行动
   * 健康）状况
   * 子流

   为了简化思考过程，让我们暂时关注 Action 节点。

* Template，用于渲染节点的模板，包括以下内容：
   * 输入端口，对于那些没有任何输入端口的触发节点，例如文件代理，这是可选的；
   * 输出端口，对于那些没有任何输出端口的动作节点，这也是可选的，例如Slack通知节点；
   * 属性字段，我们假设它是一个键值对列表

为了用户体验的目的，我们需要显示节点的状态，比如它是否正在运行，或者完成，或者失败等。所以我们需要添加以下字段：

* 状态，以下之一：
   * 准备好
   * 跑步
   * 完全的
   * 失败的
* Progress，节点的进度，从0到100

* 结果预览

   这个是可选的，只有在节点完成时才可用（比如一个文件代理节点，可以预览文件的内容，或者图片生成任务完成后，我们应该可以通过某种方式预览生成的图片 )

### 连线（Edge）

根据定义，边是两个节点之间的连接，具有以下关键属性：

* 唯一身份
* 源节点ID
* Source handle ID，源节点输出端口的ID。 如果不指定，默认使用最新的
* 目标节点ID
* 连接类型，以下之一：Line、Bezier、Step
* Animated，边缘是否动画，默认为false

这些和react-flow中的定义基本一致。 当我们对此有更多想法时，我们将扩展文档。

